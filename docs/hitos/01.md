# Milestone 01: Foundation Infrastructure and Authentication

**Status:** In Progress  
**Version:** 1.0.0  
**Last Updated:** 2025-12-29  
**Classification:** Technical Implementation Specification

---

## 1. Milestone Objectives

This milestone establishes the foundational infrastructure for the accreditation management system, implementing core architectural patterns and authentication mechanisms required for subsequent feature development.

### 1.1 Deliverables

- **Repository Structure:** NestJS-based modular monolith implementing hexagonal architecture (ports/adapters pattern) with clear separation of concerns
- **Environment Configuration:** Type-safe configuration management with runtime validation and secure credential handling
- **Continuous Integration:** Automated quality gates for pull requests and main branch (linting, testing, build verification)
- **Continuous Deployment:** Railway deployment pipeline with GitHub integration
- **Authentication Infrastructure:** OpenID Connect (OIDC) integration with JWT validation against JWKS endpoint
- **Health Monitoring:** Unauthenticated health check endpoint for infrastructure monitoring
- **User Context Endpoint:** Authenticated endpoint returning current user information from validated JWT claims

### 1.2 Out of Scope (Future Milestones)

- Database integration and migration system
- Business domain modules (documental, access, vehicle, casino)
- Multi-tenancy implementation
- Comprehensive API documentation (Swagger/OpenAPI)

---

## 2. Architectural Principles

### 2.1 Hexagonal Architecture Implementation

**Pattern:** Ports and Adapters with clear dependency inversion

**Layer Responsibilities:**
- **Domain Layer:** Pure business logic (not applicable in this milestone)
- **Application Layer:** Use cases and port interfaces
- **Infrastructure Layer:** Concrete implementations (OIDC client, HTTP adapters)
- **Interface Layer:** HTTP controllers and request/response transformation

**Dependency Rule:** Dependencies point inward (Interface ‚Üí Application ‚Üí Domain ‚Üê Infrastructure)

### 2.2 Configuration Management Strategy

**Principles:**
- **Type Safety:** All environment variables validated at application startup
- **Fail-Fast:** Invalid configuration prevents application boot
- **Security:** Sensitive credentials never committed to version control
- **Flexibility:** Support for environment-specific configuration files

---

## 3. Project Structure

### 3.1 Directory Layout

```
src/
‚îú‚îÄ‚îÄ main.ts                           # Application entry point
‚îú‚îÄ‚îÄ app.module.ts                     # Root module orchestration
‚îÇ
‚îú‚îÄ‚îÄ config/                           # Configuration layer
‚îÇ   ‚îú‚îÄ‚îÄ env.schema.ts                 # Zod schema for environment validation
‚îÇ   ‚îú‚îÄ‚îÄ env.module.ts                 # Global configuration module
‚îÇ   ‚îî‚îÄ‚îÄ env.service.ts                # Type-safe configuration accessor
‚îÇ
‚îú‚îÄ‚îÄ modules/                          # Feature modules
‚îÇ   ‚îú‚îÄ‚îÄ health/                       # Health check module
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ health.controller.ts      # HTTP endpoint
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ health.module.ts          # Module definition
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dto/                      # Data transfer objects
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ health-response.dto.ts
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ auth/                         # Authentication module
‚îÇ       ‚îú‚îÄ‚îÄ auth.module.ts            # Module definition
‚îÇ       ‚îú‚îÄ‚îÄ application/              # Application layer
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ports/                # Port interfaces
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ oidc-client.port.ts
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ auth.service.ts   # Authentication orchestration
‚îÇ       ‚îú‚îÄ‚îÄ infrastructure/           # Infrastructure layer
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ oidc.client.ts        # OIDC client implementation
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ guards/
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ oidc-auth.guard.ts
‚îÇ       ‚îú‚îÄ‚îÄ interface/                # Interface layer
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ me.controller.ts
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ dto/
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ user-info.dto.ts
‚îÇ       ‚îî‚îÄ‚îÄ domain/                   # Domain types
‚îÇ           ‚îî‚îÄ‚îÄ user-claims.ts
‚îÇ
‚îú‚îÄ‚îÄ shared/                           # Cross-cutting concerns
‚îÇ   ‚îú‚îÄ‚îÄ decorators/                   # Custom decorators
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ current-user.decorator.ts
‚îÇ   ‚îú‚îÄ‚îÄ filters/                      # Exception filters
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ http-exception.filter.ts
‚îÇ   ‚îî‚îÄ‚îÄ interceptors/                 # Request/response interceptors
‚îÇ       ‚îî‚îÄ‚îÄ logging.interceptor.ts
‚îÇ
‚îî‚îÄ‚îÄ test/                             # E2E tests
    ‚îú‚îÄ‚îÄ health.e2e-spec.ts
    ‚îî‚îÄ‚îÄ auth.e2e-spec.ts
```

---

## 4. Implementation Details

### 4.1 Environment Configuration

#### 4.1.1 Environment Schema (`src/config/env.schema.ts`)

```typescript
import { z } from 'zod';

/**
 * Environment variable schema with runtime validation
 * Ensures type safety and prevents misconfiguration at startup
 */
export const envSchema = z.object({
  // Server Configuration
  PORT: z.coerce.number().int().positive().default(3000),
  NODE_ENV: z.enum(['development', 'test', 'production']).default('development'),
  
  // OIDC Configuration (Keycloak)
  OIDC_ISSUER_URL: z.string().url({
    message: 'OIDC_ISSUER_URL must be a valid URL',
  }),
  OIDC_CLIENT_ID: z.string().min(1, {
    message: 'OIDC_CLIENT_ID is required',
  }),
  OIDC_CLIENT_SECRET: z.string().optional(),
  OIDC_JWKS_URL: z.string().url().optional(),
  
  // Database Configuration (for future milestones)
  DATABASE_URL: z.string().optional(),
  
  // Object Storage Configuration (for future milestones)
  BUCKET_ENDPOINT: z.string().url().optional(),
  BUCKET_NAME: z.string().optional(),
  BUCKET_ACCESS_KEY_ID: z.string().optional(),
  BUCKET_SECRET_ACCESS_KEY: z.string().optional(),
  BUCKET_REGION: z.string().default('us-east-1'),
  
  // Observability
  LOG_LEVEL: z.enum(['error', 'warn', 'info', 'debug', 'verbose']).default('info'),
  ENABLE_REQUEST_LOGGING: z.coerce.boolean().default(true),
});

export type Env = z.infer<typeof envSchema>;
```

#### 4.1.2 Configuration Module (`src/config/env.module.ts`)

```typescript
import { Global, Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { envSchema } from './env.schema';
import { EnvService } from './env.service';

/**
 * Global configuration module
 * Validates environment variables at application startup
 * Provides type-safe access to configuration values
 */
@Global()
@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
      envFilePath: ['.env.local', '.env'],
      cache: true,
      expandVariables: true,
      validate: (config) => {
        try {
          return envSchema.parse(config);
        } catch (error) {
          console.error('‚ùå Environment validation failed:');
          console.error(error);
          throw new Error('Invalid environment configuration');
        }
      },
    }),
  ],
  providers: [EnvService],
  exports: [EnvService],
})
export class EnvModule {}
```

#### 4.1.3 Configuration Service (`src/config/env.service.ts`)

```typescript
import { Injectable } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import type { Env } from './env.schema';

/**
 * Type-safe configuration service
 * Provides strongly-typed access to validated environment variables
 */
@Injectable()
export class EnvService {
  constructor(private readonly config: ConfigService<Env, true>) {}

  // Server Configuration
  get port(): number {
    return this.config.get('PORT', { infer: true });
  }

  get nodeEnv(): 'development' | 'test' | 'production' {
    return this.config.get('NODE_ENV', { infer: true });
  }

  get isDevelopment(): boolean {
    return this.nodeEnv === 'development';
  }

  get isProduction(): boolean {
    return this.nodeEnv === 'production';
  }

  // OIDC Configuration
  get oidcIssuerUrl(): string {
    return this.config.get('OIDC_ISSUER_URL', { infer: true });
  }

  get oidcClientId(): string {
    return this.config.get('OIDC_CLIENT_ID', { infer: true });
  }

  get oidcClientSecret(): string | undefined {
    return this.config.get('OIDC_CLIENT_SECRET', { infer: true });
  }

  get oidcJwksUrl(): string | undefined {
    return this.config.get('OIDC_JWKS_URL', { infer: true });
  }

  // Observability
  get logLevel(): string {
    return this.config.get('LOG_LEVEL', { infer: true });
  }

  get enableRequestLogging(): boolean {
    return this.config.get('ENABLE_REQUEST_LOGGING', { infer: true });
  }
}
```

#### 4.1.4 Environment File Template (`.env.example`)

```bash
# =============================================================================
# Server Configuration
# =============================================================================
PORT=3000
NODE_ENV=development

# =============================================================================
# OpenID Connect (OIDC) Configuration
# =============================================================================
# Keycloak issuer URL (realm-specific)
OIDC_ISSUER_URL=https://keycloak-development-57a1.up.railway.app/realms/accred-dev

# Client credentials for backend service
OIDC_CLIENT_ID=backend-service
OIDC_CLIENT_SECRET=__PUT_SECRET_HERE__

# Optional: Explicit JWKS endpoint (auto-discovered if not provided)
# OIDC_JWKS_URL=https://keycloak-development-57a1.up.railway.app/realms/accred-dev/protocol/openid-connect/certs

# =============================================================================
# Database Configuration (PostgreSQL) - OPTIONAL (for future milestones)
# =============================================================================
# DATABASE_URL=postgresql://postgres:postgres@localhost:5432/accred?schema=public

# =============================================================================
# Object Storage Configuration (S3-Compatible) - OPTIONAL (for future milestones)
# =============================================================================
# BUCKET_ENDPOINT=
# BUCKET_NAME=
# BUCKET_ACCESS_KEY_ID=
# BUCKET_SECRET_ACCESS_KEY=
# BUCKET_REGION=us-east-1

# =============================================================================
# Observability and Logging
# =============================================================================
LOG_LEVEL=info
ENABLE_REQUEST_LOGGING=true
```

#### 4.1.5 Local Environment File (`.env.local`)

```bash
# This file contains actual credentials for local development
# NEVER commit this file to version control
# Copy from .env.example and fill with real values

# =============================================================================
# MANDATORY VARIABLES (required for application to start)
# =============================================================================
PORT=3000
NODE_ENV=development
OIDC_ISSUER_URL=https://keycloak-development-57a1.up.railway.app/realms/accred-dev
OIDC_CLIENT_ID=backend-service

# =============================================================================
# OPTIONAL VARIABLES (have defaults or not needed yet)
# =============================================================================
# OIDC_CLIENT_SECRET=your-secret-here
# OIDC_JWKS_URL=https://keycloak-development-57a1.up.railway.app/realms/accred-dev/protocol/openid-connect/certs
# DATABASE_URL=postgresql://postgres:postgres@localhost:5432/accred?schema=public
# BUCKET_ENDPOINT=
# BUCKET_NAME=
# BUCKET_ACCESS_KEY_ID=
# BUCKET_SECRET_ACCESS_KEY=
# BUCKET_REGION=us-east-1
# LOG_LEVEL=info
# ENABLE_REQUEST_LOGGING=true
```

**Git Configuration:** Ensure `.env.local` is in `.gitignore`

**Variables Obligatorias:**
- `PORT` - Puerto del servidor (default: 3000)
- `NODE_ENV` - Ambiente de ejecuci√≥n (default: development)
- `OIDC_ISSUER_URL` - URL del issuer de Keycloak (OBLIGATORIO)
- `OIDC_CLIENT_ID` - ID del cliente en Keycloak (OBLIGATORIO)

**Variables Opcionales:**
- `OIDC_CLIENT_SECRET` - Solo si tu cliente en Keycloak es confidencial
- `OIDC_JWKS_URL` - Se auto-descubre desde OIDC_ISSUER_URL si no se provee
- `DATABASE_URL` - Para milestone 02+
- `BUCKET_*` - Para milestone 02+
- `LOG_LEVEL` - Nivel de logging (default: info)
- `ENABLE_REQUEST_LOGGING` - Habilitar logging de requests (default: true)

---

### 4.2 Health Check Module

#### 4.2.1 Health Response DTO (`src/modules/health/dto/health-response.dto.ts`)

```typescript
import { ApiProperty } from '@nestjs/swagger';

/**
 * Health check response data transfer object
 */
export class HealthResponseDto {
  @ApiProperty({
    description: 'Health status indicator',
    example: true,
  })
  ok: boolean;

  @ApiProperty({
    description: 'Application version',
    example: '1.0.0',
  })
  version: string;

  @ApiProperty({
    description: 'Current environment',
    example: 'development',
  })
  environment: string;

  @ApiProperty({
    description: 'Server timestamp (ISO 8601)',
    example: '2025-12-29T04:47:00.000Z',
  })
  timestamp: string;

  @ApiProperty({
    description: 'Service uptime in seconds',
    example: 3600,
  })
  uptime: number;
}
```

#### 4.2.2 Health Controller (`src/modules/health/health.controller.ts`)

```typescript
import { Controller, Get } from '@nestjs/common';
import { ApiTags, ApiOperation, ApiResponse } from '@nestjs/swagger';
import { HealthResponseDto } from './dto/health-response.dto';
import { EnvService } from '@/config/env.service';

/**
 * Health check controller
 * Provides unauthenticated endpoint for infrastructure monitoring
 */
@ApiTags('Health')
@Controller('health')
export class HealthController {
  private readonly startTime: number;

  constructor(private readonly envService: EnvService) {
    this.startTime = Date.now();
  }

  @Get()
  @ApiOperation({
    summary: 'Health check endpoint',
    description: 'Returns application health status and metadata',
  })
  @ApiResponse({
    status: 200,
    description: 'Service is healthy',
    type: HealthResponseDto,
  })
  health(): HealthResponseDto {
    return {
      ok: true,
      version: process.env.npm_package_version || '1.0.0',
      environment: this.envService.nodeEnv,
      timestamp: new Date().toISOString(),
      uptime: Math.floor((Date.now() - this.startTime) / 1000),
    };
  }
}
```

#### 4.2.3 Health Module (`src/modules/health/health.module.ts`)

```typescript
import { Module } from '@nestjs/common';
import { HealthController } from './health.controller';

/**
 * Health check module
 * Provides infrastructure monitoring capabilities
 */
@Module({
  controllers: [HealthController],
})
export class HealthModule {}
```

---

### 4.3 Authentication Module

#### 4.3.1 Domain Types (`src/modules/auth/domain/user-claims.ts`)

```typescript
/**
 * Standardized user claims extracted from JWT
 * Maps OIDC token claims to application domain model
 */
export interface UserClaims {
  /** Unique user identifier (sub claim) */
  userId: string;

  /** User email address */
  email: string;

  /** Email verification status */
  emailVerified: boolean;

  /** User's full name */
  name?: string;

  /** User's given name */
  givenName?: string;

  /** User's family name */
  familyName?: string;

  /** Preferred username */
  preferredUsername?: string;

  /** Assigned roles */
  roles: string[];

  /** Token issuer */
  issuer: string;

  /** Token subject */
  subject: string;

  /** Token issued at timestamp */
  issuedAt: number;

  /** Token expiration timestamp */
  expiresAt: number;
}
```

#### 4.3.2 OIDC Client Port (`src/modules/auth/application/ports/oidc-client.port.ts`)

```typescript
import { UserClaims } from '../../domain/user-claims';

/**
 * Port interface for OIDC client implementations
 * Enables dependency inversion and testability
 */
export interface OidcClientPort {
  /**
   * Validates JWT token and extracts user claims
   * @param token - Bearer token from Authorization header
   * @returns Validated user claims
   * @throws UnauthorizedException if token is invalid
   */
  validateToken(token: string): Promise<UserClaims>;

  /**
   * Retrieves JWKS (JSON Web Key Set) from issuer
   * @returns Public keys for token verification
   */
  getJwks(): Promise<any>;
}

export const OIDC_CLIENT_PORT = Symbol('OIDC_CLIENT_PORT');
```

#### 4.3.3 OIDC Client Implementation (`src/modules/auth/infrastructure/oidc.client.ts`)

```typescript
import { Injectable, UnauthorizedException, Logger } from '@nestjs/common';
import { JwksClient } from 'jwks-rsa';
import * as jwt from 'jsonwebtoken';
import { EnvService } from '@/config/env.service';
import { OidcClientPort } from '../application/ports/oidc-client.port';
import { UserClaims } from '../domain/user-claims';

/**
 * OIDC client implementation using jwks-rsa
 * Validates JWT tokens against Keycloak JWKS endpoint
 */
@Injectable()
export class OidcClient implements OidcClientPort {
  private readonly logger = new Logger(OidcClient.name);
  private readonly jwksClient: JwksClient;

  constructor(private readonly envService: EnvService) {
    const jwksUrl =
      this.envService.oidcJwksUrl ||
      `${this.envService.oidcIssuerUrl}/protocol/openid-connect/certs`;

    this.jwksClient = new JwksClient({
      jwksUri: jwksUrl,
      cache: true,
      cacheMaxAge: 3600000, // 1 hora de cache para las claves p√∫blicas
      rateLimit: true,
      jwksRequestsPerMinute: 10,
    });

    this.logger.log(`OIDC client initialized with JWKS URL: ${jwksUrl}`);
  }

  async validateToken(token: string): Promise<UserClaims> {
    try {
      const decoded = jwt.decode(token, { complete: true });

      if (!decoded || typeof decoded === 'string') {
        throw new UnauthorizedException('Invalid token format');
      }

      const kid = decoded.header.kid;
      if (!kid) {
        throw new UnauthorizedException('Token missing key ID (kid)');
      }

      const key = await this.jwksClient.getSigningKey(kid);
      const publicKey = key.getPublicKey();

      const verified = jwt.verify(token, publicKey, {
        issuer: this.envService.oidcIssuerUrl,
        audience: this.envService.oidcClientId,
        clockTolerance: 30, // 30 segundos de tolerancia para diferencias de reloj
        algorithms: ['RS256'],
      }) as any;

      return this.mapClaimsToUserClaims(verified);
    } catch (error) {
      this.logger.warn(`Token validation failed: ${error.message}`);
      throw new UnauthorizedException('Invalid or expired token');
    }
  }

  async getJwks(): Promise<any> {
    return this.jwksClient.getSigningKeys();
  }

  /**
   * Maps OIDC token claims to application domain model
   */
  private mapClaimsToUserClaims(claims: any): UserClaims {
    return {
      userId: claims.sub,
      email: claims.email,
      emailVerified: claims.email_verified || false,
      name: claims.name,
      givenName: claims.given_name,
      familyName: claims.family_name,
      preferredUsername: claims.preferred_username,
      roles: claims.realm_access?.roles || [],
      issuer: claims.iss,
      subject: claims.sub,
      issuedAt: claims.iat,
      expiresAt: claims.exp,
    };
  }
}
```

#### 4.3.4 Authentication Guard (`src/modules/auth/infrastructure/guards/oidc-auth.guard.ts`)

```typescript
import {
  Injectable,
  CanActivate,
  ExecutionContext,
  UnauthorizedException,
  Inject,
} from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { OidcClientPort, OIDC_CLIENT_PORT } from '../../application/ports/oidc-client.port';

export const IS_PUBLIC_KEY = 'isPublic';

/**
 * OIDC authentication guard
 * Validates JWT tokens on protected routes
 * Supports @Public() decorator for unauthenticated endpoints
 */
@Injectable()
export class OidcAuthGuard implements CanActivate {
  constructor(
    @Inject(OIDC_CLIENT_PORT) private readonly oidcClient: OidcClientPort,
    private readonly reflector: Reflector,
  ) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    const isPublic = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [
      context.getHandler(),
      context.getClass(),
    ]);

    if (isPublic) {
      return true;
    }

    const request = context.switchToHttp().getRequest();
    const authHeader = request.headers.authorization;

    if (!authHeader) {
      throw new UnauthorizedException('Missing Authorization header');
    }

    const [scheme, token] = authHeader.split(' ');

    if (scheme !== 'Bearer' || !token) {
      throw new UnauthorizedException('Invalid Authorization header format');
    }

    try {
      const userClaims = await this.oidcClient.validateToken(token);
      request.user = userClaims;
      return true;
    } catch (error) {
      throw new UnauthorizedException('Invalid or expired token');
    }
  }
}
```

#### 4.3.5 User Info DTO (`src/modules/auth/interface/dto/user-info.dto.ts`)

```typescript
import { ApiProperty } from '@nestjs/swagger';

/**
 * User information response DTO
 */
export class UserInfoDto {
  @ApiProperty({
    description: 'Unique user identifier',
    example: '123e4567-e89b-12d3-a456-426614174000',
  })
  userId: string;

  @ApiProperty({
    description: 'User email address',
    example: 'user@example.com',
  })
  email: string;

  @ApiProperty({
    description: 'Email verification status',
    example: true,
  })
  emailVerified: boolean;

  @ApiProperty({
    description: 'User full name',
    example: 'John Doe',
    required: false,
  })
  name?: string;

  @ApiProperty({
    description: 'Preferred username',
    example: 'johndoe',
    required: false,
  })
  preferredUsername?: string;

  @ApiProperty({
    description: 'Assigned roles',
    example: ['user', 'admin'],
    type: [String],
  })
  roles: string[];
}
```

#### 4.3.6 Me Controller (`src/modules/auth/interface/controllers/me.controller.ts`)

```typescript
import { Controller, Get, UseGuards } from '@nestjs/common';
import { ApiTags, ApiOperation, ApiResponse, ApiBearerAuth } from '@nestjs/swagger';
import { OidcAuthGuard } from '../../infrastructure/guards/oidc-auth.guard';
import { CurrentUser } from '@/shared/decorators/current-user.decorator';
import { UserClaims } from '../../domain/user-claims';
import { UserInfoDto } from '../dto/user-info.dto';

/**
 * User context controller
 * Provides authenticated user information
 */
@ApiTags('Authentication')
@Controller('me')
@UseGuards(OidcAuthGuard)
@ApiBearerAuth()
export class MeController {
  @Get()
  @ApiOperation({
    summary: 'Get current user information',
    description: 'Returns authenticated user claims from validated JWT',
  })
  @ApiResponse({
    status: 200,
    description: 'User information retrieved successfully',
    type: UserInfoDto,
  })
  @ApiResponse({
    status: 401,
    description: 'Unauthorized - Invalid or missing token',
  })
  getCurrentUser(@CurrentUser() user: UserClaims): UserInfoDto {
    return {
      userId: user.userId,
      email: user.email,
      emailVerified: user.emailVerified,
      name: user.name,
      preferredUsername: user.preferredUsername,
      roles: user.roles,
    };
  }
}
```

#### 4.3.7 Authentication Module (`src/modules/auth/auth.module.ts`)

```typescript
import { Module } from '@nestjs/common';
import { APP_GUARD } from '@nestjs/core';
import { OidcClient } from './infrastructure/oidc.client';
import { OidcAuthGuard } from './infrastructure/guards/oidc-auth.guard';
import { MeController } from './interface/controllers/me.controller';
import { OIDC_CLIENT_PORT } from './application/ports/oidc-client.port';

/**
 * Authentication module
 * Provides OIDC-based authentication and authorization
 */
@Module({
  controllers: [MeController],
  providers: [
    {
      provide: OIDC_CLIENT_PORT,
      useClass: OidcClient,
    },
    {
      provide: APP_GUARD,
      useClass: OidcAuthGuard,
    },
  ],
  exports: [OIDC_CLIENT_PORT],
})
export class AuthModule {}
```

---

### 4.4 Shared Components

#### 4.4.1 Current User Decorator (`src/shared/decorators/current-user.decorator.ts`)

```typescript
import { createParamDecorator, ExecutionContext } from '@nestjs/common';
import { UserClaims } from '@/modules/auth/domain/user-claims';

/**
 * Custom parameter decorator to extract authenticated user from request
 * Usage: @CurrentUser() user: UserClaims
 */
export const CurrentUser = createParamDecorator(
  (data: unknown, ctx: ExecutionContext): UserClaims => {
    const request = ctx.switchToHttp().getRequest();
    return request.user;
  },
);
```

#### 4.4.2 Public Decorator (`src/shared/decorators/public.decorator.ts`)

```typescript
import { SetMetadata } from '@nestjs/common';

export const IS_PUBLIC_KEY = 'isPublic';

/**
 * Decorator to mark routes as public (bypass authentication)
 * Usage: @Public()
 */
export const Public = () => SetMetadata(IS_PUBLIC_KEY, true);
```

#### 4.4.3 HTTP Exception Filter (`src/shared/filters/http-exception.filter.ts`)

```typescript
import {
  ExceptionFilter,
  Catch,
  ArgumentsHost,
  HttpException,
  HttpStatus,
  Logger,
} from '@nestjs/common';
import { Request, Response } from 'express';

/**
 * Global HTTP exception filter
 * Standardizes error response format
 */
@Catch(HttpException)
export class HttpExceptionFilter implements ExceptionFilter {
  private readonly logger = new Logger(HttpExceptionFilter.name);

  catch(exception: HttpException, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const request = ctx.getRequest<Request>();
    const status = exception.getStatus();
    const exceptionResponse = exception.getResponse();

    const errorResponse = {
      statusCode: status,
      timestamp: new Date().toISOString(),
      path: request.url,
      method: request.method,
      message:
        typeof exceptionResponse === 'string'
          ? exceptionResponse
          : (exceptionResponse as any).message || 'Internal server error',
      error:
        typeof exceptionResponse === 'object'
          ? (exceptionResponse as any).error
          : undefined,
    };

    if (status >= HttpStatus.INTERNAL_SERVER_ERROR) {
      this.logger.error(
        `${request.method} ${request.url}`,
        exception.stack,
        'HttpExceptionFilter',
      );
    } else {
      this.logger.warn(
        `${request.method} ${request.url} - ${errorResponse.message}`,
        'HttpExceptionFilter',
      );
    }

    response.status(status).json(errorResponse);
  }
}
```

#### 4.4.4 Logging Interceptor (`src/shared/interceptors/logging.interceptor.ts`)

```typescript
import {
  Injectable,
  NestInterceptor,
  ExecutionContext,
  CallHandler,
  Logger,
} from '@nestjs/common';
import { Observable } from 'rxjs';
import { tap } from 'rxjs/operators';
import { EnvService } from '@/config/env.service';

/**
 * Request/response logging interceptor
 * Logs HTTP request details and response times
 */
@Injectable()
export class LoggingInterceptor implements NestInterceptor {
  private readonly logger = new Logger(LoggingInterceptor.name);

  constructor(private readonly envService: EnvService) {}

  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    if (!this.envService.enableRequestLogging) {
      return next.handle();
    }

    const request = context.switchToHttp().getRequest();
    const { method, url, ip } = request;
    const userAgent = request.get('user-agent') || '';
    const startTime = Date.now();

    this.logger.log(`‚Üí ${method} ${url} - ${ip} - ${userAgent}`);

    return next.handle().pipe(
      tap({
        next: () => {
          const response = context.switchToHttp().getResponse();
          const { statusCode } = response;
          const duration = Date.now() - startTime;
          this.logger.log(
            `‚Üê ${method} ${url} ${statusCode} - ${duration}ms`,
          );
        },
        error: (error) => {
          const duration = Date.now() - startTime;
          this.logger.error(
            `‚Üê ${method} ${url} ${error.status || 500} - ${duration}ms - ${error.message}`,
          );
        },
      }),
    );
  }
}
```

---

### 4.5 Application Bootstrap

#### 4.5.1 Root Module (`src/app.module.ts`)

```typescript
import { Module } from '@nestjs/common';
import { APP_FILTER, APP_INTERCEPTOR } from '@nestjs/core';
import { EnvModule } from './config/env.module';
import { HealthModule } from './modules/health/health.module';
import { AuthModule } from './modules/auth/auth.module';
import { HttpExceptionFilter } from './shared/filters/http-exception.filter';
import { LoggingInterceptor } from './shared/interceptors/logging.interceptor';

/**
 * Root application module
 * Orchestrates all feature modules and global providers
 */
@Module({
  imports: [
    EnvModule,
    HealthModule,
    AuthModule,
  ],
  providers: [
    {
      provide: APP_FILTER,
      useClass: HttpExceptionFilter,
    },
    {
      provide: APP_INTERCEPTOR,
      useClass: LoggingInterceptor,
    },
  ],
})
export class AppModule {}
```

#### 4.5.2 Application Entry Point (`src/main.ts`)

```typescript
import { NestFactory } from '@nestjs/core';
import { ValidationPipe, Logger } from '@nestjs/common';
import { SwaggerModule, DocumentBuilder } from '@nestjs/swagger';
import { AppModule } from './app.module';
import { EnvService } from './config/env.service';

async function bootstrap() {
  const logger = new Logger('Bootstrap');

  const app = await NestFactory.create(AppModule, {
    logger: ['error', 'warn', 'log', 'debug', 'verbose'],
  });

  const envService = app.get(EnvService);

  app.useGlobalPipes(
    new ValidationPipe({
      whitelist: true,
      forbidNonWhitelisted: true,
      transform: true,
      transformOptions: {
        enableImplicitConversion: true,
      },
    }),
  );

  app.enableCors({
    origin: envService.isDevelopment
      ? '*'
      : ['https://app.example.com'],
    credentials: true,
  });

  if (envService.isDevelopment) {
    const config = new DocumentBuilder()
      .setTitle('Accreditation Management API')
      .setDescription('Enterprise accreditation and access control system')
      .setVersion('1.0.0')
      .addBearerAuth()
      .build();

    const document = SwaggerModule.createDocument(app, config);
    SwaggerModule.setup('api/docs', app, document);

    logger.log('üìö Swagger documentation available at /api/docs');
  }

  const port = envService.port;
  await app.listen(port);

  logger.log(`üöÄ Application running on port ${port}`);
  logger.log(`üåç Environment: ${envService.nodeEnv}`);
  logger.log(`üîê OIDC Issuer: ${envService.oidcIssuerUrl}`);
}

bootstrap();
```

---

## 5. Continuous Integration and Deployment

### 5.1 GitHub Actions Workflow (`.github/workflows/ci.yml`)

```yaml
name: CI/CD Pipeline

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

jobs:
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run type-check

      - name: Run unit tests
        run: npm run test:unit

      - name: Run E2E tests
        run: npm run test:e2e
        env:
          OIDC_ISSUER_URL: ${{ secrets.OIDC_ISSUER_URL }}
          OIDC_CLIENT_ID: ${{ secrets.OIDC_CLIENT_ID }}

      - name: Build application
        run: npm run build

      - name: Upload build artifacts
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  deploy:
    name: Deploy to Railway
    needs: quality-gates
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Railway
        uses: bervProject/railway-deploy@main
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
          service: backend-api
```

### 5.2 Railway Configuration (`railway.json`)

```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "npm run build"
  },
  "deploy": {
    "startCommand": "npm run start:prod",
    "healthcheckPath": "/health",
    "healthcheckTimeout": 300,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 3
  }
}
```

---

## 6. Testing Strategy

### 6.1 Unit Tests Example (`src/modules/health/health.controller.spec.ts`)

```typescript
import { Test, TestingModule } from '@nestjs/testing';
import { HealthController } from './health.controller';
import { EnvService } from '@/config/env.service';

describe('HealthController', () => {
  let controller: HealthController;
  let envService: EnvService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [HealthController],
      providers: [
        {
          provide: EnvService,
          useValue: {
            nodeEnv: 'test',
          },
        },
      ],
    }).compile();

    controller = module.get<HealthController>(HealthController);
    envService = module.get<EnvService>(EnvService);
  });

  it('should be defined', () => {
    expect(controller).toBeDefined();
  });

  describe('health', () => {
    it('should return health status', () => {
      const result = controller.health();

      expect(result).toHaveProperty('ok', true);
      expect(result).toHaveProperty('version');
      expect(result).toHaveProperty('environment', 'test');
      expect(result).toHaveProperty('timestamp');
      expect(result).toHaveProperty('uptime');
    });

    it('should return valid ISO timestamp', () => {
      const result = controller.health();
      const timestamp = new Date(result.timestamp);

      expect(timestamp.toISOString()).toBe(result.timestamp);
    });
  });
});
```

### 6.2 E2E Tests Example (`test/health.e2e-spec.ts`)

```typescript
import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import * as request from 'supertest';
import { AppModule } from '@/app.module';

describe('Health (e2e)', () => {
  let app: INestApplication;

  beforeAll(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    await app.init();
  });

  afterAll(async () => {
    await app.close();
  });

  it('/health (GET)', () => {
    return request(app.getHttpServer())
      .get('/health')
      .expect(200)
      .expect((res) => {
        expect(res.body).toHaveProperty('ok', true);
        expect(res.body).toHaveProperty('version');
        expect(res.body).toHaveProperty('environment');
        expect(res.body).toHaveProperty('timestamp');
        expect(res.body).toHaveProperty('uptime');
      });
  });
});
```

---

## 7. Dependencies

### 7.1 Production Dependencies

```json
{
  "dependencies": {
    "@nestjs/common": "^10.3.0",
    "@nestjs/core": "^10.3.0",
    "@nestjs/platform-express": "^10.3.0",
    "@nestjs/config": "^3.1.1",
    "@nestjs/swagger": "^7.1.17",
    "jsonwebtoken": "^9.0.2",
    "jwks-rsa": "^3.1.0",
    "zod": "^3.22.4",
    "reflect-metadata": "^0.1.14",
    "rxjs": "^7.8.1"
  }
}
```

### 7.2 Development Dependencies

```json
{
  "devDependencies": {
    "@nestjs/cli": "^10.2.1",
    "@nestjs/schematics": "^10.0.3",
    "@nestjs/testing": "^10.3.0",
    "@types/express": "^4.17.21",
    "@types/jest": "^29.5.11",
    "@types/jsonwebtoken": "^9.0.5",
    "jest": "^29.7.0",
    "prettier": "^3.1.1",
    "supertest": "^6.3.3",
    "ts-jest": "^29.1.1",
    "ts-loader": "^9.5.1",
    "tsconfig-paths": "^4.2.0",
    "typescript": "^5.3.3"
  }
}
```

---

## 8. Acceptance Criteria

### 8.1 Functional Requirements

- ‚úÖ `GET /health` returns 200 with health status (unauthenticated)
- ‚úÖ `GET /me` returns 401 without valid JWT token
- ‚úÖ `GET /me` returns 200 with user claims when valid token provided
- ‚úÖ JWT validation against JWKS endpoint successful
- ‚úÖ Invalid/expired tokens rejected with 401
- ‚úÖ Environment validation prevents startup with invalid configuration

### 8.2 Non-Functional Requirements

- ‚úÖ TypeScript compilation passes without errors
- ‚úÖ Unit test coverage > 80%
- ‚úÖ E2E tests for critical paths
- ‚úÖ Build completes without errors
- ‚úÖ Application starts in < 5 seconds
- ‚úÖ Health check responds in < 100ms

### 8.3 Deployment Requirements

- ‚úÖ Railway deployment successful via GitHub integration
- ‚úÖ Environment variables configured in Railway dashboard
- ‚úÖ Health check endpoint accessible post-deployment
- ‚úÖ Application logs visible in Railway console

---

## 9. Future Enhancements (Milestone 02+)

- Database integration with Prisma ORM
- Database migration system
- Multi-tenancy implementation
- Role-based access control (RBAC)
- API rate limiting
- Request correlation IDs
- Distributed tracing (OpenTelemetry)
- Metrics collection (Prometheus)
- Comprehensive API documentation

---

## 10. References

- [NestJS Documentation](https://docs.nestjs.com/)
- [Hexagonal Architecture](https://alistair.cockburn.us/hexagonal-architecture/)
- [OpenID Connect Specification](https://openid.net/connect/)
- [Keycloak Documentation](https://www.keycloak.org/documentation)
- [Railway Documentation](https://docs.railway.app/)
- [Zod Schema Validation](https://zod.dev/)
